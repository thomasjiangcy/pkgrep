name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-artifacts:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - runner: macos-15-intel
            target: x86_64-apple-darwin
          - runner: macos-15
            target: aarch64-apple-darwin

    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.2

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo artifacts
        uses: Swatinem/rust-cache@v2.8.2

      - name: Build
        run: cargo build --release --locked --target ${{ matrix.target }}

      - name: Package artifact
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"
          TARGET="${{ matrix.target }}"
          ARCHIVE="pkgrep-${TAG}-${TARGET}.tar.gz"

          mkdir -p dist
          cp "target/${TARGET}/release/pkgrep" dist/pkgrep
          tar -C dist -czf "${ARCHIVE}" pkgrep
          shasum -a 256 "${ARCHIVE}" > "${ARCHIVE}.sha256"

      - name: Upload artifact
        uses: actions/upload-artifact@v6.0.0
        with:
          name: pkgrep-${{ matrix.target }}
          path: |
            pkgrep-${{ github.ref_name }}-${{ matrix.target }}.tar.gz
            pkgrep-${{ github.ref_name }}-${{ matrix.target }}.tar.gz.sha256
          if-no-files-found: error

  publish-release:
    name: Publish GitHub Release
    runs-on: ubuntu-latest
    needs: build-artifacts

    steps:
      - name: Download built artifacts
        uses: actions/download-artifact@v7.0.0
        with:
          path: dist

      - name: Prepare checksums
        shell: bash
        run: |
          set -euo pipefail
          find dist -name "*.sha256" -type f -print0 | xargs -0 cat > checksums.txt

      - name: Create release
        uses: softprops/action-gh-release@v2.5.0
        with:
          files: |
            dist/**/*.tar.gz
            dist/**/*.sha256
            checksums.txt
          generate_release_notes: true

  publish-tap-formula:
    name: Publish Homebrew Tap Formula
    runs-on: ubuntu-latest
    needs: publish-release
    steps:
      - name: Validate configuration
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${{ vars.HOMEBREW_TAP_REPOSITORY }}" ]; then
            echo "Repository variable HOMEBREW_TAP_REPOSITORY is required (example: owner/homebrew-tap)." >&2
            exit 1
          fi
          if [ -z "${{ secrets.HOMEBREW_TAP_GITHUB_TOKEN }}" ]; then
            echo "Secret HOMEBREW_TAP_GITHUB_TOKEN is required to push formula updates." >&2
            exit 1
          fi

      - name: Download release artifacts
        env:
          GH_TOKEN: ${{ github.token }}
          RELEASE_TAG: ${{ github.ref_name }}
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p release-assets
          gh release download "${RELEASE_TAG}" --repo "${GITHUB_REPOSITORY}" --dir release-assets

      - name: Generate Homebrew formula
        env:
          RELEASE_TAG: ${{ github.ref_name }}
        shell: bash
        run: |
          set -euo pipefail
          TAG="${RELEASE_TAG}"
          VERSION="${TAG#v}"
          OWNER_REPO="${GITHUB_REPOSITORY}"
          BASE_URL="https://github.com/${OWNER_REPO}/releases/download/${TAG}"

          MAC_ARM_TARGET="aarch64-apple-darwin"
          MAC_INTEL_TARGET="x86_64-apple-darwin"
          LINUX_TARGET="x86_64-unknown-linux-gnu"

          checksum_for() {
            local target="$1"
            local archive="pkgrep-${TAG}-${target}.tar.gz"
            awk -v archive="${archive}" '$2 == archive { print $1 }' release-assets/checksums.txt
          }

          MAC_ARM_SHA="$(checksum_for "${MAC_ARM_TARGET}")"
          MAC_INTEL_SHA="$(checksum_for "${MAC_INTEL_TARGET}")"
          LINUX_SHA="$(checksum_for "${LINUX_TARGET}")"

          mkdir -p generated/Formula
          cat > generated/Formula/pkgrep.rb <<EOF
          class Pkgrep < Formula
            desc "Dependency source cache helper for developers and coding agents"
            homepage "https://github.com/${OWNER_REPO}"
            version "${VERSION}"
            license "MIT"

            on_macos do
              if Hardware::CPU.arm?
                url "${BASE_URL}/pkgrep-${TAG}-${MAC_ARM_TARGET}.tar.gz"
                sha256 "${MAC_ARM_SHA}"
              else
                url "${BASE_URL}/pkgrep-${TAG}-${MAC_INTEL_TARGET}.tar.gz"
                sha256 "${MAC_INTEL_SHA}"
              end
            end

            on_linux do
              url "${BASE_URL}/pkgrep-${TAG}-${LINUX_TARGET}.tar.gz"
              sha256 "${LINUX_SHA}"
            end

            def install
              bin.install "pkgrep"
            end

            test do
              assert_match "pkgrep", shell_output("#{bin}/pkgrep --help")
            end
          end
          EOF

      - name: Push formula to tap
        env:
          TAP_REPOSITORY: ${{ vars.HOMEBREW_TAP_REPOSITORY }}
          TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_GITHUB_TOKEN }}
          RELEASE_TAG: ${{ github.ref_name }}
        shell: bash
        run: |
          set -euo pipefail
          git clone "https://x-access-token:${TAP_TOKEN}@github.com/${TAP_REPOSITORY}.git" tap-repo
          mkdir -p tap-repo/Formula
          cp generated/Formula/pkgrep.rb tap-repo/Formula/pkgrep.rb

          cd tap-repo
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add Formula/pkgrep.rb
          if git diff --cached --quiet; then
            echo "No formula changes to publish."
            exit 0
          fi
          git commit -m "pkgrep ${RELEASE_TAG}"
          git push origin HEAD
