name: Homebrew Tap Publish

on:
  release:
    types: [published]

permissions:
  contents: read

jobs:
  publish-tap-formula:
    runs-on: ubuntu-latest
    steps:
      - name: Validate configuration
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${{ vars.HOMEBREW_TAP_REPOSITORY }}" ]; then
            echo "Repository variable HOMEBREW_TAP_REPOSITORY is required (example: owner/homebrew-tap)." >&2
            exit 1
          fi
          if [ -z "${{ secrets.HOMEBREW_TAP_GITHUB_TOKEN }}" ]; then
            echo "Secret HOMEBREW_TAP_GITHUB_TOKEN is required to push formula updates." >&2
            exit 1
          fi

      - name: Download release artifacts
        env:
          GH_TOKEN: ${{ github.token }}
          RELEASE_TAG: ${{ github.event.release.tag_name }}
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p release-assets
          gh release download "${RELEASE_TAG}" --repo "${GITHUB_REPOSITORY}" --dir release-assets

      - name: Generate Homebrew formula
        env:
          RELEASE_TAG: ${{ github.event.release.tag_name }}
        shell: bash
        run: |
          set -euo pipefail
          TAG="${RELEASE_TAG}"
          VERSION="${TAG#v}"
          OWNER_REPO="${GITHUB_REPOSITORY}"
          BASE_URL="https://github.com/${OWNER_REPO}/releases/download/${TAG}"

          MAC_ARM_TARGET="aarch64-apple-darwin"
          MAC_INTEL_TARGET="x86_64-apple-darwin"
          LINUX_TARGET="x86_64-unknown-linux-gnu"

          checksum_for() {
            local target="$1"
            local file="release-assets/pkgrep-${TAG}-${target}.tar.gz.sha256"
            awk '{print $1}' "$file"
          }

          MAC_ARM_SHA="$(checksum_for "${MAC_ARM_TARGET}")"
          MAC_INTEL_SHA="$(checksum_for "${MAC_INTEL_TARGET}")"
          LINUX_SHA="$(checksum_for "${LINUX_TARGET}")"

          mkdir -p generated/Formula
          cat > generated/Formula/pkgrep.rb <<EOF
          class Pkgrep < Formula
            desc "Dependency source cache helper for developers and coding agents"
            homepage "https://github.com/${OWNER_REPO}"
            version "${VERSION}"
            license "MIT"

            on_macos do
              if Hardware::CPU.arm?
                url "${BASE_URL}/pkgrep-${TAG}-${MAC_ARM_TARGET}.tar.gz"
                sha256 "${MAC_ARM_SHA}"
              else
                url "${BASE_URL}/pkgrep-${TAG}-${MAC_INTEL_TARGET}.tar.gz"
                sha256 "${MAC_INTEL_SHA}"
              end
            end

            on_linux do
              url "${BASE_URL}/pkgrep-${TAG}-${LINUX_TARGET}.tar.gz"
              sha256 "${LINUX_SHA}"
            end

            def install
              bin.install "pkgrep"
            end

            test do
              assert_match "pkgrep", shell_output("#{bin}/pkgrep --help")
            end
          end
          EOF

      - name: Push formula to tap
        env:
          TAP_REPOSITORY: ${{ vars.HOMEBREW_TAP_REPOSITORY }}
          TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_GITHUB_TOKEN }}
          RELEASE_TAG: ${{ github.event.release.tag_name }}
        shell: bash
        run: |
          set -euo pipefail
          git clone "https://x-access-token:${TAP_TOKEN}@github.com/${TAP_REPOSITORY}.git" tap-repo
          mkdir -p tap-repo/Formula
          cp generated/Formula/pkgrep.rb tap-repo/Formula/pkgrep.rb

          cd tap-repo
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add Formula/pkgrep.rb
          if git diff --cached --quiet; then
            echo "No formula changes to publish."
            exit 0
          fi
          git commit -m "pkgrep ${RELEASE_TAG}"
          git push origin HEAD
